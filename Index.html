<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»„é‡‘è¿½è¸ªç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Flatpickr æ—¥æœŸé€‰æ‹©åº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh.js"></script>
    <!-- å¼•å…¥ Confetti æ’’èŠ±åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-bg': '#F4F7F9',
                        'card-bg': '#FFFFFF',
                        'accent': '#FFD700',     // Bright Gold
                        'accent-dark': '#B8860B',// Darker Gold for text/hover
                        'text-dark': '#1F2937',
                        'text-secondary': '#6B7280',
                        'ai-blue': '#4285F4',
                        'danger': '#EF4444',
                        'danger-hover': '#DC2626'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        .gold-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06), 0 0 15px rgba(255, 215, 0, 0.4);
        }
        .tab-active {
            color: #1F2937;
            background-color: #FFD700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* Modal Overlay - Pure Black Semi-transparent (No Blur) */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75); /* Darker, stronger contrast */
            transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        .modal-hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .modal-visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 3px;
        }
        /* Accordion Animation Fix */
        .group-content-expanded {
            max-height: 5000px;
            opacity: 1;
            padding: 1rem;
            transition: max-height 0.5s ease-in-out, opacity 0.4s ease-in-out, padding 0.4s ease;
            will-change: max-height, opacity;
            overflow: hidden; 
        }
        .group-content-collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 1rem;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, padding 0.4s ease;
            will-change: max-height, opacity;
        }
        .arrow-rotated {
            transform: rotate(-90deg);
        }
        .arrow-icon {
            display: inline-block;
            transition: transform 0.3s ease;
        }
        
        /* Updated Light Tooltip Style */
        .tooltip-container {
            position: relative;
        }
        .tooltip-content {
            opacity: 0;
            visibility: hidden;
            position: absolute;
            bottom: 100%; 
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 0.75rem;
            background-color: #FFFFFF; 
            color: #1F2937; 
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 50;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0,0,0,0.05); 
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }
        .tooltip-content::after {
            content: " ";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: #FFFFFF transparent transparent transparent; 
            filter: drop-shadow(0 2px 1px rgba(0,0,0,0.05));
        }
        .tooltip-container:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }

        .unit-g {
            font-size: 0.75rem; 
            font-weight: 600;
            color: #B8860B; 
            margin-left: 1px;
            opacity: 0.8;
        }
        
        .flatpickr-calendar {
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border: none;
            z-index: 9999 !important; /* Ensure datepicker is above modal */
        }
        .flatpickr-day.selected {
            background: #FFD700 !important;
            border-color: #FFD700 !important;
            color: #1F2937 !important;
            font-weight: bold;
        }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } 
                 from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, orderBy, onSnapshot, 
            addDoc, doc, setDoc, updateDoc, deleteDoc, 
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // =========================================================================
        // Firebase Configuration (ç”¨æˆ·æä¾›çš„é…ç½®)
        // =========================================================================
        const APP_ID = 'gold-tracker-for-github';
        const firebaseConfig = {
            apiKey: "AIzaSyDdiFvy_VzCtpZcQJ2qCY3__rriupBsK-8",
            authDomain: "lovegoldtracker.firebaseapp.com",
            projectId: "lovegoldtracker",
            storageBucket: "lovegoldtracker.firebasestorage.app",
            messagingSenderId: "522732534050",
            appId: "1:522732534050:web:3f4ffdf23a715698a04d7b"
        };
        // =========================================================================

        const appId = APP_ID; 

        // --- Firebase Initialization ---
        setLogLevel('Debug');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        // -------------------------------
        
        let userId = null;
        let isAuthReady = false;
        let currentReasons = [];
        let currentEvents = []; 
        let currentProfile = {};
        let currentPage = 'dashboard';
        
        let isReturnToEvent = false; 
        let collapsedReasons = new Set();
        let datePickerInstance = null;
        
        // --- Helper: Confetti Effect ---
        window.triggerConfetti = () => {
            if (typeof confetti !== 'undefined') {
                const count = 200;
                const defaults = { origin: { y: 0.7 } };
                function fire(particleRatio, opts) {
                    confetti(Object.assign({}, defaults, opts, {
                        particleCount: Math.floor(count * particleRatio)
                    }));
                }
                fire(0.25, { spread: 26, startVelocity: 55, colors: ['#FFD700', '#FFA500'] }); 
                fire(0.2, { spread: 60 });
                fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
                fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
                fire(0.1, { spread: 120, startVelocity: 45 });
            }
        };

        // --- Helper: Number Animation ---
        window.animateValue = (id, start, end, duration) => {
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = (progress * (end - start) + start).toFixed(1);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        };

        window.toggleReasonGroup = (reasonId) => {
            const content = document.getElementById(`group-content-${reasonId}`);
            const arrow = document.getElementById(`arrow-icon-${reasonId}`);
            
            if (collapsedReasons.has(reasonId)) {
                collapsedReasons.delete(reasonId);
                content.classList.remove('group-content-collapsed');
                content.classList.add('group-content-expanded');
                arrow.classList.remove('arrow-rotated');
            } else {
                collapsedReasons.add(reasonId);
                content.classList.remove('group-content-expanded');
                content.classList.add('group-content-collapsed');
                arrow.classList.add('arrow-rotated');
            }
        };

        const toggleModal = (modalId, show) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (show) {
                    modal.classList.remove('modal-hidden');
                    modal.classList.add('modal-visible');
                } else {
                    modal.classList.add('modal-hidden');
                    modal.classList.remove('modal-visible');
                }
            }
        };

        window.openNameModal = () => {
            const femaleInput = document.getElementById('female-name-input');
            const maleInput = document.getElementById('male-name-input');
            const titleInput = document.getElementById('app-title-input'); 

            if (femaleInput && maleInput && titleInput) {
                femaleInput.value = currentProfile.femaleName || '';
                maleInput.value = currentProfile.maleName || '';
                titleInput.value = currentProfile.appTitle || ''; 
            }
            toggleModal('name-edit-modal', true);
        };
        window.closeNameModal = () => toggleModal('name-edit-modal', false);

        window.openAddEventModal = (eventId = null) => {
            // 1. Check if reasons exist
            if (!eventId && currentReasons.length === 0) {
                // Show message first, wait for completion, then open reason modal
                showMessage('ğŸ¥º è¿˜æ²¡æœ‰ä»»ä½•äº‹ç”±ï¼è¯·å…ˆå»æ·»åŠ ä¸€ä¸ªå§...', false, 2000, () => {
                    isReturnToEvent = true; 
                    window.openAddReasonModal(); 
                });
                return;
            }
            
            const selectEl = document.getElementById('reason-select');
            selectEl.innerHTML = '<option value="" disabled selected>-- è¯·é€‰æ‹©ä¸€ä¸ªäº‹ç”± --</option>';
            currentReasons.forEach(r => {
                selectEl.innerHTML += `<option value="${r.id}">${r.name} (å•æ¬¡ä¸Šé™: ${r.maxGold}g)</option>`;
            });
            
            // Initialize Datepicker
            if(datePickerInstance) datePickerInstance.destroy();
            datePickerInstance = flatpickr("#event-date-input", {
                locale: "zh",
                dateFormat: "Y-m-d",
                defaultDate: "today",
                disableMobile: "true", 
                theme: "light"
            });

            if (eventId) {
                const event = currentEvents.find(e => e.id === eventId);
                if (!event) { showMessage('äº‹ä»¶æœªæ‰¾åˆ°ã€‚', true); return; }
        
                document.getElementById('event-modal-title').textContent = `âœï¸ ç¼–è¾‘äº‹ä»¶`;
                document.getElementById('event-submit-btn').textContent = 'ä¿å­˜ä¿®æ”¹';
                
                document.getElementById('event-id-input').value = eventId;
                document.getElementById('description-input').value = event.description;
                selectEl.value = event.reasonId; 
                datePickerInstance.setDate(event.date);

                document.getElementById('edit-reason-name-display').textContent = event.reasonName;
                document.getElementById('edit-gold-amount-display').textContent = event.goldAmount.toFixed(1);
                
                document.getElementById('event-edit-display').classList.remove('hidden');

            } else {
                document.getElementById('event-modal-title').textContent = 'âœï¸ è®°å½•æ–°çš„äº‹ä»¶';
                document.getElementById('event-submit-btn').textContent = 'æ·»åŠ äº‹ä»¶'; 
                document.getElementById('add-event-form').reset();
                document.getElementById('event-id-input').value = ''; 
                
                document.getElementById('event-edit-display').classList.add('hidden');
                datePickerInstance.setDate(new Date());
            }
            
            toggleModal('add-event-modal', true);
        };
        
        window.openEditEventModal = (eventId) => window.openAddEventModal(eventId);
        window.closeAddEventModal = () => toggleModal('add-event-modal', false);
        
        window.openAddReasonModal = () => {
            document.getElementById('reason-modal-title').textContent = 'â• æ–°å¢äº‹ç”±';
            document.getElementById('reason-id-input').value = '';
            document.getElementById('add-reason-form').reset();
            toggleModal('add-reason-modal', true);
        };
        
        window.quickAddReason = () => {
            window.closeAddEventModal();
            isReturnToEvent = true;
            window.openAddReasonModal();
        };

        window.openEditReasonModal = (reasonId) => {
            const reason = currentReasons.find(r => r.id === reasonId);
            if (!reason) { showMessage('äº‹ç”±æœªæ‰¾åˆ°ã€‚', true); return; }

            document.getElementById('reason-modal-title').textContent = `âœï¸ ç¼–è¾‘äº‹ç”±: ${reason.name}`;
            document.getElementById('reason-id-input').value = reasonId;
            document.getElementById('new-reason-name').value = reason.name;
            document.getElementById('new-max-gold').value = reason.maxGold;
            toggleModal('add-reason-modal', true);
        };

        window.closeAddReasonModal = () => toggleModal('add-reason-modal', false);
        window.closeGlobalInsightModal = () => toggleModal('global-insight-modal', false);
        
        // --- Firestore Path Helpers using APP_ID ---
        const getReasonsCollection = (uid) => collection(db, `artifacts/${appId}/users/${uid}/reasons`);
        const getEventsCollection = (uid) => collection(db, `artifacts/${appId}/users/${uid}/events`);
        const getProfileDoc = (uid) => doc(db, `artifacts/${appId}/users/${uid}/settings/profile`);

        const calculateGoldAmount = (eventCount, maxGold) => {
            const nextCount = eventCount + 1; 
            let gold = 0;
            if (nextCount === 1) gold = 1;
            else if (nextCount === 2) gold = 2;
            else if (nextCount === 3) gold = 4;
            else if (nextCount === 4) gold = 8;
            else gold = maxGold;
            return Math.min(gold, maxGold); 
        };

        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = ""; 

        window.getGlobalGeminiInsight = async () => {
            if (currentEvents.length === 0) {
                showMessage("è¿˜æ²¡æœ‰ä»»ä½•äº‹ä»¶è®°å½•ï¼Œæ— æ³•ç”Ÿæˆåˆ†ææŠ¥å‘Šå“¦ã€‚", true);
                return;
            }

            toggleModal('global-insight-modal', true);
            const resultEl = document.getElementById('global-insight-content');
            
            resultEl.innerHTML = `
                <div class="flex flex-col items-center justify-center py-10 space-y-4">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-ai-blue"></div>
                    <p class="text-ai-blue font-semibold animate-pulse">Gemini æ­£åœ¨åˆ†ææ‚¨çš„é»„é‡‘ç§¯ç´¯å†å²...</p>
                </div>
            `;

            const totalGold = currentEvents.reduce((sum, e) => sum + (e.goldAmount || 0), 0);
            const reasonSummary = currentReasons.map(r => {
                const count = currentEvents.filter(e => e.reasonId === r.id).length;
                return `${r.name}(${count}æ¬¡)`;
            }).join(', ');
            
            const recentEvents = currentEvents.slice(-10).map(e => 
                `[${e.date.toLocaleDateString()}] å›  "${e.reasonName}" (å¤‡æ³¨:${e.description}) è·å¾— ${e.goldAmount}g`
            ).join('; ');

            const systemPrompt = `ä½ æ˜¯ä¸€ä½å¹½é»˜ã€æ¯’èˆŒä½†å¿ƒåœ°å–„è‰¯çš„æƒ…æ„Ÿä¸è´¢å¯Œé¡¾é—®ã€‚è¿™å¯¹æƒ…ä¾£ä½¿ç”¨ä¸€ä¸ª"é»„é‡‘è¿½è¸ªç³»ç»Ÿ"æ¥è®°å½•ç”·æ–¹æƒ¹å¥³æ–¹ç”Ÿæ°”æˆ–é€šè¿‡ç‰¹å®šè¡Œä¸º"å­˜å…¥æƒ…æ„Ÿé»„é‡‘"çš„è¿‡ç¨‹ã€‚
            è¯·é˜…è¯»ä»¥ä¸‹æ•°æ®ï¼š
            1. æ€»çè—: ${totalGold}å…‹ã€‚
            2. çè—æ¥æºåˆ†å¸ƒ: ${reasonSummary}ã€‚
            3. æœ€è¿‘10æ¡è®°å½•: ${recentEvents}ã€‚
            
            è¯·ç”¨ä¸­æ–‡è¾“å‡ºä¸€ä»½ç®€çŸ­çš„åˆ†ææŠ¥å‘Šï¼ˆHTMLæ ¼å¼ï¼Œä¸è¦Markdownä»£ç å—ï¼‰ã€‚åŒ…å«ï¼š
            1. **è´¢å¯Œï¼ˆæƒ…æ„Ÿï¼‰ä½“æ£€**ï¼šç”¨å¹½é»˜çš„æ–¹å¼è¯„ä»·ä»–ä»¬ç›®å‰çš„"å«é‡‘é‡"å’Œå…³ç³»çŠ¶æ€ã€‚
            2. **è¶‹åŠ¿æ´å¯Ÿ**ï¼šæ ¹æ®æœ€è¿‘çš„äº‹ä»¶ï¼ŒæŒ‡å‡ºç”·æ–¹æœ€è¿‘çš„è¡¨ç°è¶‹åŠ¿ã€‚
            3. **æŠ•èµ„å»ºè®®**ï¼šç»™è¿™å¯¹æƒ…ä¾£ä¸€å¥å…³äºæœªæ¥ç›¸å¤„çš„å»ºè®®ã€‚
            è¯­æ°”è¦è½»æ¾ã€è°ƒä¾ƒã€‚ä¸è¦ä½¿ç”¨"å…‘æ¢"è¿™ä¸ªè¯ï¼Œä½¿ç”¨"å­˜å…¥"æˆ–"çè—"ã€‚`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: "è¯·ç”ŸæˆæŠ¥å‘Šã€‚" }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    resultEl.innerHTML = `<div class="prose prose-sm max-w-none text-text-dark leading-relaxed space-y-2">${text}</div>`;
                } else {
                    resultEl.innerHTML = `<p class="text-red-500 text-center">ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</p>`;
                }
            } catch (error) {
                console.error(error);
                resultEl.innerHTML = `<p class="text-red-500 text-center">ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥åˆ° AIã€‚</p>`;
            }
        };

        // --- Authentication Logic for GitHub Deployment ---
        const initializeAuth = async () => {
            try {
                // FIXED: Adding detailed logging for configuration error diagnosis
                console.log("Attempting to sign in anonymously. Checking config...");
                console.log("authDomain:", firebaseConfig.authDomain);
                console.log("projectId:", firebaseConfig.projectId);

                // Always sign in anonymously for simplicity on GitHub Pages
                await signInAnonymously(auth);
                console.log("Anonymous sign-in successful!");
            } catch (error) { 
                console.error("Firebase authentication failed:", error);
                
                // CRITICAL: Display a user-friendly error if config/auth is wrong
                let errorMessage = "è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Firebase æ§åˆ¶å°è®¾ç½®ã€‚";
                if (error.code === 'auth/configuration-not-found') {
                    errorMessage = "Firebase è®¤è¯é…ç½®é”™è¯¯ (auth/configuration-not-found)ã€‚è¯·æ£€æŸ¥æ‚¨çš„ Firebase é¡¹ç›®ä¸­æ˜¯å¦å·²å¯ç”¨ 'åŒ¿åè®¤è¯'ã€‚";
                }
                
                document.getElementById('app').innerHTML = `<div class="p-8 text-center text-red-600 bg-red-100 rounded-xl">
                    âš ï¸ **è®¤è¯æœåŠ¡é”™è¯¯**ï¼š${errorMessage}
                </div>`;
            }
        };
        
        // ShowMessage function with callback support for sequential flows
        const showMessage = (message, isError = false, duration = 2000, onComplete = null) => {
            const modal = document.getElementById('custom-modal');
            const contentWrapper = document.getElementById('modal-content-wrapper');
            const messageEl = document.getElementById('modal-message');

            messageEl.textContent = message;
            contentWrapper.classList.remove('scale-95', 'opacity-0'); 
            contentWrapper.classList.add('scale-100', 'opacity-100');
            contentWrapper.className = `relative p-6 rounded-xl shadow-2xl w-full max-w-sm bg-white transition duration-300 transform 
                ${isError ? 'border-l-4 border-red-500' : 'border-l-4 border-accent'} scale-100 opacity-100`; 
            messageEl.className = `text-base font-semibold ${isError ? 'text-red-700' : 'text-text-dark'}`;
            modal.classList.remove('hidden');

            const hideModal = () => {
                contentWrapper.classList.remove('scale-100', 'opacity-100');
                contentWrapper.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { 
                    modal.classList.add('hidden'); 
                    if (onComplete) onComplete(); // Trigger callback ONLY after animation finishes
                }, 300); 
            };
            
            if (window.modalTimeout) clearTimeout(window.modalTimeout);
            window.modalTimeout = setTimeout(hideModal, duration); 
        };

        window.closeModal = () => {
            const modal = document.getElementById('custom-modal');
            const contentWrapper = document.getElementById('modal-content-wrapper');
            if (window.modalTimeout) clearTimeout(window.modalTimeout); 
            contentWrapper.classList.remove('scale-100', 'opacity-100');
            contentWrapper.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                contentWrapper.classList.remove('scale-95', 'opacity-0'); 
                contentWrapper.classList.add('scale-100', 'opacity-100');
            }, 300); 
        };
        
        const customConfirm = (message, onConfirm) => {
            const modal = document.getElementById('custom-confirm-modal');
            document.getElementById('confirm-message').textContent = message;
            modal.classList.remove('hidden');
            const confirmBtn = document.getElementById('confirm-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            confirmBtn.onclick = () => { modal.classList.add('hidden'); onConfirm(true); };
            cancelBtn.onclick = () => { modal.classList.add('hidden'); onConfirm(false); };
        };

        const setupDataListeners = (uid) => {
            if (!uid) return;
            const qReasons = query(getReasonsCollection(uid), orderBy('createdAt', 'asc'));
            onSnapshot(qReasons, (snapshot) => {
                currentReasons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp(); 
            });

            const qEvents = query(getEventsCollection(uid)); 
            onSnapshot(qEvents, (snapshot) => {
                let fetchedEvents = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data,
                        date: data.date ? data.date.toDate() : new Date(),
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(0), 
                    };
                });
                fetchedEvents.sort((a, b) => {
                    if (a.date.getTime() !== b.date.getTime()) return a.date.getTime() - b.date.getTime();
                    return a.createdAt.getTime() - b.createdAt.getTime();
                });
                currentEvents = fetchedEvents; 
                renderApp(); 
            });
            
            const profileRef = getProfileDoc(uid);
            onSnapshot(profileRef, async (docSnap) => {
                // Removed sparkles from default title
                const defaultProfile = { femaleName: 'LINGDOR', maleName: 'å°éƒ­', appTitle: 'é»„é‡‘è¿½è¸ªç³»ç»Ÿ' };
                if (docSnap.exists()) {
                    currentProfile = { ...defaultProfile, ...docSnap.data() };
                } else {
                    if(userId) await setDoc(profileRef, defaultProfile, { merge: true }).catch(console.error);
                    currentProfile = defaultProfile;
                }
                renderApp();
            });
        };

        window.handleSaveNames = async (event) => {
            event.preventDefault();
            const appTitle = document.getElementById('app-title-input').value.trim(); 
            const femaleName = document.getElementById('female-name-input').value.trim();
            const maleName = document.getElementById('male-name-input').value.trim();
            if (!femaleName || !maleName || !appTitle) return showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ã€‚', true);
            try {
                await setDoc(getProfileDoc(userId), { femaleName, maleName, appTitle }, { merge: true }); 
                closeNameModal();
                showMessage('è®¾ç½®å·²æ›´æ–°ï¼'); 
            } catch (error) { showMessage('ä¿å­˜å¤±è´¥ã€‚', true); }
        };

        window.handleSaveReason = async (event) => {
            event.preventDefault();
            const form = event.target;
            const reasonId = form.reasonId.value; 
            const name = form.reasonName.value.trim();
            const maxGold = Math.max(1, parseInt(form.maxGold.value, 10));

            if (!name || isNaN(maxGold) || maxGold <= 0) return showMessage('æ— æ•ˆè¾“å…¥ã€‚', true);
            
            const isDuplicate = currentReasons.some(r => r.name === name && r.id !== reasonId);
            if (isDuplicate) return showMessage('è¯¥äº‹ç”±å·²å­˜åœ¨ï¼Œè¯·å‹¿é‡å¤æ·»åŠ ã€‚', true);

            try {
                const reasonData = { name, maxGold, userId };
                if (reasonId) {
                    await updateDoc(doc(db, getReasonsCollection(userId).path, reasonId), reasonData);
                    showMessage(`äº‹ç”± "${name}" æ›´æ–°æˆåŠŸï¼`);
                } else {
                    reasonData.createdAt = serverTimestamp();
                    await addDoc(getReasonsCollection(userId), reasonData);
                    // UX: If returning to event modal, use callback to ensure sequence
                    if (isReturnToEvent) {
                        showMessage(`äº‹ç”± "${name}" æ·»åŠ æˆåŠŸï¼`, false, 1500, () => {
                            isReturnToEvent = false;
                            window.openAddEventModal();
                        });
                    } else {
                        showMessage(`äº‹ç”± "${name}" æ·»åŠ æˆåŠŸï¼`);
                    }
                }
                form.reset();
                closeAddReasonModal();

            } catch (error) { showMessage('ä¿å­˜å¤±è´¥ã€‚', true); }
        };
        
        window.deleteEvent = (eventId) => {
            customConfirm('ç¡®å®šè¦åˆ é™¤æ­¤äº‹ä»¶è®°å½•å—ï¼Ÿ', async (confirmed) => {
                if (confirmed) {
                    try {
                        await deleteDoc(doc(db, getEventsCollection(userId).path, eventId));
                        showMessage('äº‹ä»¶å·²åˆ é™¤ã€‚');
                    } catch (error) { showMessage('åˆ é™¤å¤±è´¥ã€‚', true); }
                }
            });
        };
        
        window.deleteReason = (reasonId, reasonName) => {
            customConfirm(`ç¡®å®šè¦åˆ é™¤äº‹ç”± "${reasonName}" å—ï¼Ÿ`, async (confirmed) => {
                if (confirmed) {
                    try {
                        await deleteDoc(doc(db, getReasonsCollection(userId).path, reasonId));
                        showMessage(`äº‹ç”± "${reasonName}" å·²åˆ é™¤ã€‚`);
                    } catch (error) { showMessage('åˆ é™¤å¤±è´¥ã€‚', true); }
                }
            });
        };

        window.handleSaveEvent = async (event) => {
            event.preventDefault();
            const form = event.target;
            const eventId = form.eventId.value; 
            const description = form.description.value.trim();
            const reasonId = form.reasonSelect.value;
            const dateString = form.eventDate.value;

            if (!description || !reasonId || !dateString) return showMessage('è¯·å¡«å†™å®Œæ•´ã€‚', true);

            try {
                const selectedReason = currentReasons.find(r => r.id === reasonId);
                // CRITICAL FIX: Ensure local date is preserved, not UTC
                let selectedDate;
                if (datePickerInstance && datePickerInstance.selectedDates.length > 0) {
                    selectedDate = datePickerInstance.selectedDates[0];
                } else {
                    // Fallback logic just in case: append time to force local parsing
                    selectedDate = new Date(dateString.replace(/-/g, '/') + ' 00:00:00');
                }

                const eventData = { reasonId, date: selectedDate, description, reasonName: selectedReason.name };
                
                if (eventId) {
                    await updateDoc(doc(db, getEventsCollection(userId).path, eventId), eventData); 
                    showMessage(`äº‹ä»¶æ›´æ–°æˆåŠŸï¼`);
                } else {
                    const currentCount = currentEvents.filter(e => e.reasonId === reasonId).length;
                    const goldAmount = calculateGoldAmount(currentCount, selectedReason.maxGold);
                    eventData.goldAmount = goldAmount; 
                    eventData.userId = userId;
                    eventData.createdAt = serverTimestamp();
                    await addDoc(getEventsCollection(userId), eventData);
                    // TRIGGER CONFETTI AND FUN MESSAGE
                    window.triggerConfetti();
                    showMessage(`å¤ªå¯æ¶äº†ï¼æœ¬æ¬¡ç«Ÿå­˜å…¥ ${goldAmount.toFixed(1)} å…‹ ğŸ˜ `);
                }
                form.reset();
                closeAddEventModal();
            } catch (error) { showMessage('ä¿å­˜å¤±è´¥ã€‚', true); }
        };
        
        window.navigateTo = (page) => {
            currentPage = page;
            renderApp();
            window.scrollTo(0, 0); 
        };

        const renderDashboard = (recalculatedEvents, reasonMap, totalGold, reasonCounts) => {
            let eventsTooltipHtml = '';
            let reasonsTooltipHtml = '';

            // Tooltip for Total Events (Show Reason Breakdown)
            if (currentReasons.length > 0) {
                 eventsTooltipHtml = `<div class="tooltip-content w-64">
                    <p class="font-bold border-b border-gray-200 pb-1 mb-1 text-gray-700">äº‹ä»¶åˆ†å¸ƒ</p>
                    <ul class="space-y-1">
                        ${currentReasons.map(r => {
                            const count = reasonCounts[r.id]?.count || 0;
                            return `<li class="flex justify-between text-gray-600"><span>${r.name}:</span> <span>${count} æ¬¡</span></li>`;
                        }).join('')}
                    </ul>
                </div>`;
                
                reasonsTooltipHtml = `<div class="tooltip-content w-64">
                    <p class="font-bold border-b border-gray-200 pb-1 mb-1 text-gray-700">äº‹ç”±åˆ—è¡¨</p>
                    <ul class="space-y-1">
                        ${currentReasons.map(r => {
                            return `<li class="flex justify-between text-gray-600"><span>${r.name}</span> <span class="text-xs text-gray-400">ä¸Šé™${r.maxGold}g</span></li>`;
                        }).join('')}
                    </ul>
                </div>`;
            }

            const summaryHtml = `
                <div class="p-6 bg-card-bg rounded-2xl shadow-xl border-t-8 border-accent gold-shadow mb-8 relative z-10">
                    <div class="flex flex-col sm:flex-row items-center justify-between">
                        <div class="text-center sm:text-left mb-4 sm:mb-0">
                            <p class="text-xl font-light text-text-secondary">ğŸ‰ ç´¯è®¡é»„é‡‘çè—æ€»é‡</p>
                            <div class="flex items-end justify-center sm:justify-start">
                                <!-- Added ID for animation -->
                                <h1 id="total-gold-display" class="text-6xl font-extrabold text-text-dark leading-none mr-3">${totalGold.toFixed(1)}</h1>
                                <span class="text-3xl font-semibold text-accent">g</span>
                            </div>
                        </div>
                        <div class="flex space-x-6">
                            <div class="tooltip-container group">
                                <div class="text-center p-3 bg-primary-bg rounded-xl shadow-inner border border-gray-100 min-w-[120px] cursor-help">
                                    <p class="text-2xl font-bold text-text-dark">${recalculatedEvents.length}</p>
                                    <p class="text-sm text-text-secondary">æ€»äº‹ä»¶æ•°</p>
                                </div>
                                ${eventsTooltipHtml}
                            </div>
                            <div class="tooltip-container group">
                                <div class="text-center p-3 bg-primary-bg rounded-xl shadow-inner border border-gray-100 min-w-[120px] cursor-help">
                                    <p class="text-2xl font-bold text-text-dark">${currentReasons.length}</p>
                                    <p class="text-sm text-text-secondary">äº‹ç”±åˆ†ç±»</p>
                                </div>
                                ${reasonsTooltipHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const groupedEvents = {};
            recalculatedEvents.forEach(e => {
                const id = e.reasonId;
                if (!groupedEvents[id]) groupedEvents[id] = { reason: reasonMap[id] || { name: 'æœªçŸ¥', maxGold: 0 }, events: [] };
                groupedEvents[id].events.push(e);
            });
            const sortedGroups = Object.values(groupedEvents).sort((a, b) => a.reason.name.localeCompare(b.reason.name, 'zh-CN'));
            
            const groupedListHtml = sortedGroups.map(group => {
                const reasonId = group.reason.id;
                const reasonStats = reasonCounts[reasonId] || { count: 0, totalGold: 0 };
                
                const isCollapsed = collapsedReasons.has(reasonId);
                const contentClass = isCollapsed ? 'group-content-collapsed' : 'group-content-expanded';
                const arrowClass = isCollapsed ? 'arrow-rotated' : '';

                const displayEvents = [...group.events].reverse();
                
                const eventCardsHtml = displayEvents.map(e => {
                    const dateFormatted = e.date.toLocaleDateString('zh-CN', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '/');
                    return `
                        <div class="p-4 mb-3 bg-gray-50 rounded-xl border-l-4 border-gray-200 shadow-sm hover:shadow-md transition duration-200">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                                <!-- Left Side: Sequence + Date + Description -->
                                <div class="flex-1 min-w-0 pr-2 w-full"> 
                                    <div class="flex items-center space-x-3 mb-1">
                                        <!-- Changed background to accent (yellow) and text to dark -->
                                        <span class="text-base font-extrabold text-text-dark bg-accent px-2.5 py-0.5 rounded-lg">#${e.sequenceIndex}</span>
                                        <p class="text-xl font-extrabold text-text-dark">${dateFormatted}</p>
                                    </div>
                                    <p class="text-base text-gray-500 leading-snug break-words pl-1">${e.description}</p>
                                </div>
                                
                                <!-- Right Side: Gold + Actions (Never Wrap) -->
                                <div class="flex-shrink-0 flex items-center bg-white rounded-lg sm:bg-transparent self-end sm:self-center mt-2 sm:mt-0">
                                    <div class="text-right whitespace-nowrap mr-4">
                                        <span class="text-xl font-bold text-accent">${e.goldAmount.toFixed(1)}</span><span class="unit-g">g</span>
                                    </div>
                                    <div class="flex items-center space-x-1 border-l pl-2 border-gray-200">
                                        <button onclick="openEditEventModal('${e.id}')" class="group p-2 rounded hover:bg-gray-100 transition" title="ç¼–è¾‘">
                                            <svg class="w-5 h-5 text-gray-400 group-hover:text-ai-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                        </button>
                                        <button onclick="deleteEvent('${e.id}')" class="group p-2 rounded hover:bg-red-50 transition" title="åˆ é™¤">
                                            <svg class="w-5 h-5 text-gray-400 group-hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-card-bg rounded-xl shadow-lg mb-4 overflow-hidden border border-gray-100">
                        <div onclick="toggleReasonGroup('${reasonId}')"
                            class="w-full p-4 flex justify-between items-center bg-primary-bg border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition select-none">
                            <div class="flex items-center space-x-3">
                                <span id="arrow-icon-${reasonId}" class="text-xl font-bold text-text-dark arrow-icon ${arrowClass}">&#9660;</span>
                                <span class="text-xl font-bold text-text-dark">${group.reason.name}</span>
                                <span class="text-sm text-text-secondary ml-2 font-normal">(${reasonStats.count}æ¡)</span>
                            </div>
                            <div class="text-right">
                                <!-- Larger font size for category totals -->
                                <span class="text-accent text-2xl font-extrabold mr-1">${reasonStats.totalGold.toFixed(1)}</span><span class="unit-g">g</span>
                            </div>
                        </div>

                        <div id="group-content-${reasonId}" class="${contentClass}">
                            ${displayEvents.length > 0 ? eventCardsHtml : '<p class="text-center text-text-secondary italic py-4">æš‚æ— è®°å½•ã€‚</p>'}
                        </div>
                    </div>
                `;
            }).join('');
            
            const listHeaderHtml = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-3xl font-bold text-text-dark">äº‹ä»¶å†å²</h2>
                        <button onclick="getGlobalGeminiInsight()" class="text-xs sm:text-sm bg-indigo-50 text-ai-blue px-3 py-1.5 rounded-full hover:bg-indigo-100 transition flex items-center space-x-1 border border-indigo-200 shadow-sm">
                            <!-- Changed icon to a Report/Chart style icon and removed 'ç”Ÿæˆ' from text -->
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span>æƒ…æ„Ÿæ´å¯ŸæŠ¥å‘Š</span>
                        </button>
                    </div>
                    <button onclick="openAddEventModal()"
                        class="w-full sm:w-auto px-6 py-3 bg-accent text-text-dark font-bold rounded-xl shadow-md hover:bg-accent-dark transition duration-300 transform hover:scale-[1.02] focus:outline-none focus-ring-gold flex items-center justify-center space-x-2 text-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
                        <span>æ–°å¢äº‹ä»¶</span>
                    </button>
                </div>
            `;

            return `
                <div class="space-y-8">
                    ${summaryHtml}
                    ${listHeaderHtml}
                    <div class="max-h-[70vh] overflow-y-auto custom-scrollbar pr-2 pb-10">
                        ${recalculatedEvents.length === 0 ? '<p class="text-center text-text-secondary p-10 bg-card-bg rounded-xl shadow-md">è¿˜æ²¡æœ‰è®°å½•å“¦ï¼Œç‚¹å‡» "æ–°å¢äº‹ä»¶" å¼€å§‹è®°æœ¬æœ¬å§ï¼</p>' : groupedListHtml}
                    </div>
                </div>
            `;
        };

        const renderReasons = (reasonCounts) => {
            const reasonsListHtml = currentReasons.map(r => {
                const rc = reasonCounts[r.id] || { count: 0, totalGold: 0, name: r.name, maxGold: r.maxGold };
                return `
                    <div class="bg-card-bg p-5 rounded-xl flex justify-between items-center shadow-lg border-l-4 border-accent/70 hover:shadow-xl transition duration-300">
                        <div class="flex-grow">
                            <p class="font-bold text-xl text-text-dark mb-1">${rc.name}</p>
                            <p class="text-sm text-text-secondary">å•æ¬¡ä¸Šé™: ${rc.maxGold}g</p>
                        </div>
                        <div class="text-right min-w-[120px]">
                            <p class="text-sm text-text-secondary">æ¬¡æ•°: <span class="font-bold text-text-dark text-lg">${rc.count}</span></p>
                            <p class="text-sm text-text-secondary">ç´¯è®¡: <span class="font-bold text-accent text-xl">${rc.totalGold.toFixed(1)}</span><span class="unit-g">g</span></p>
                        </div>
                        <div class="flex items-center space-x-1 ml-6 border-l pl-4 border-gray-100">
                            <button onclick="openEditReasonModal('${r.id}')" class="group p-2 rounded hover:bg-blue-50 transition" title="ç¼–è¾‘">
                                <svg class="w-6 h-6 text-gray-300 group-hover:text-ai-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button onclick="deleteReason('${r.id}', '${r.name}')" class="group p-2 rounded hover:bg-red-50 transition" title="åˆ é™¤">
                                <svg class="w-6 h-6 text-gray-300 group-hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const listHeaderHtml = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-text-dark">äº‹ç”±ç®¡ç†</h2>
                    <button onclick="openAddReasonModal()"
                        class="px-6 py-3 bg-slate-600 text-white font-bold rounded-xl shadow-md hover:bg-slate-700 transition duration-300 transform hover:scale-[1.02] focus:outline-none focus-ring-gold flex items-center space-x-2 text-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
                        <span>æ–°å¢äº‹ç”±</span>
                    </button>
                </div>
            `;

            return `
                ${listHeaderHtml}
                <div class="space-y-4 pb-10">
                    ${reasonsListHtml}
                    ${currentReasons.length === 0 ? '<p class="text-center text-text-secondary p-10 bg-card-bg rounded-xl shadow-md">æš‚æ— äº‹ç”±è®¾ç½®ï¼Œç‚¹å‡»å³ä¸Šè§’ "æ–°å¢äº‹ç”±" åˆ›å»ºç¬¬ä¸€ä¸ªäº‹ç”±ã€‚</p>' : ''}
                </div>
            `;
        };

        const renderApp = () => {
            const appDiv = document.getElementById('app');
            if (!isAuthReady || !userId) { appDiv.innerHTML = '<div class="text-center p-8 text-text-dark">æ­£åœ¨åŠ è½½åº”ç”¨...</div>'; return; }

            const femaleName = currentProfile.femaleName || 'LINGDOR';
            const maleName = currentProfile.maleName || 'å°éƒ­';
            // Removed sparkles from fallback title as well
            const appTitle = currentProfile.appTitle || 'é»„é‡‘è¿½è¸ªç³»ç»Ÿ'; 

            let totalGold = 0;
            const reasonCounts = {};
            const reasonMap = {};
            const eventsByReason = {};
            const recalculatedEvents = [];
            
            currentReasons.forEach(r => {
                reasonMap[r.id] = r;
                reasonCounts[r.id] = { id: r.id, count: 0, totalGold: 0, name: r.name, maxGold: r.maxGold };
                eventsByReason[r.id] = [];
            });
            currentEvents.forEach(e => { if (eventsByReason[e.reasonId]) eventsByReason[e.reasonId].push(e); });

            Object.keys(eventsByReason).forEach(reasonId => {
                const events = eventsByReason[reasonId];
                const reason = reasonMap[reasonId];
                if (!reason) return; 
                events.forEach((e, index) => {
                    const calculatedGold = calculateGoldAmount(index, reason.maxGold);
                    e.goldAmount = calculatedGold; 
                    e.sequenceIndex = index + 1;
                    recalculatedEvents.push(e);
                    if (reasonCounts[reasonId]) {
                        totalGold += calculatedGold;
                        reasonCounts[reasonId].count++;
                        reasonCounts[reasonId].totalGold += calculatedGold;
                    }
                });
            });
            
            let contentHtml = currentPage === 'dashboard' ? renderDashboard(recalculatedEvents, reasonMap, totalGold, reasonCounts) : renderReasons(reasonCounts);

            appDiv.innerHTML = `
                <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                    <header class="bg-card-bg rounded-3xl p-8 mb-8 relative text-text-dark shadow-md border-t-4 border-accent">
                        <div class="text-center relative">
                            <h1 class="text-4xl font-extrabold mb-4 tracking-tight text-text-dark">${appTitle}</h1>
                            
                            <!-- Designed Names Section -->
                            <div class="flex items-center justify-center gap-2 opacity-90">
                                <div class="h-px w-8 sm:w-16 bg-gradient-to-r from-transparent via-gray-300 to-gray-400"></div>
                                <div class="flex items-center gap-1">
                                    <span class="text-lg sm:text-xl font-bold text-gray-600 tracking-widest uppercase font-sans">${femaleName}</span>
                                    <div class="w-5 h-5 rounded-full bg-yellow-50 border border-yellow-200 flex items-center justify-center text-accent-dark font-serif italic text-sm shadow-sm">
                                        &
                                    </div>
                                    <span class="text-lg sm:text-xl font-bold text-gray-600 tracking-widest uppercase font-sans">${maleName}</span>
                                </div>
                                <div class="h-px w-8 sm:w-16 bg-gradient-to-l from-transparent via-gray-300 to-gray-400"></div>
                            </div>

                            <button onclick="openNameModal()" class="absolute top-0 right-0 p-2 rounded-full hover:bg-gray-100 transition duration-200 group" title="è®¾ç½®">
                                <!-- UPDATED ICON: Box with Edit Pen -->
                                <svg class="w-6 h-6 text-gray-400 group-hover:text-text-dark transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                        </div>
                    </header>
                    
                    <nav class="flex justify-center mb-8 bg-card-bg p-2 rounded-xl shadow-inner border border-gray-200">
                        <button onclick="navigateTo('dashboard')" class="flex-1 py-3 px-4 rounded-lg font-bold text-lg transition duration-200 ${currentPage === 'dashboard' ? 'tab-active' : 'text-text-secondary hover:bg-gray-100'}">ğŸ  è¿½è¸ªä»ªè¡¨</button>
                        <button onclick="navigateTo('reasons')" class="flex-1 py-3 px-4 rounded-lg font-bold text-lg transition duration-200 ${currentPage === 'reasons' ? 'tab-active' : 'text-text-secondary hover:bg-gray-100'}">âš™ï¸ äº‹ç”±ç®¡ç†</button>
                    </nav>
                    <div class="mt-8">${contentHtml}</div>
                </div>
            `;
            
            // Trigger animation after render (only if on dashboard)
            if (currentPage === 'dashboard') {
                // Start from 0 to total
                window.animateValue("total-gold-display", 0, totalGold, 1200);
            }
        };

        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            if (user) { userId = user.uid; setupDataListeners(userId); }
            else { 
                userId = null; 
                if (!auth.currentUser) initializeAuth(); // Use anonymous sign-in
                else renderApp(); 
            }
        });

    </script>
</head>
<body class="bg-primary-bg text-text-dark font-sans min-h-screen">

    <div id="app" class="pt-8">
        <div class="text-center p-8 text-text-dark">æ­£åœ¨åŠ è½½åº”ç”¨...</div>
    </div>
    
    <!-- Name Modal (Pure Black Overlay) -->
    <div id="name-edit-modal" class="fixed inset-0 modal-overlay z-40 flex items-center justify-center p-4 modal-hidden" onclick="if(event.target.id === 'name-edit-modal') closeNameModal()">
        <div class="bg-card-bg p-6 rounded-2xl shadow-2xl w-full max-w-xl mx-auto transform transition-all">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-text-dark">ğŸŒŸ ä¼´ä¾£åå­—è®¾ç½®</h3>
                <button onclick="closeNameModal()" class="text-gray-400 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <form onsubmit="handleSaveNames(event)" class="space-y-4">
                <div><label class="block text-sm font-medium text-text-dark mb-1">åº”ç”¨æ ‡é¢˜</label><input type="text" id="app-title-input" required class="w-full px-4 py-3 border rounded-xl"></div>
                <div><label class="block text-sm font-medium text-text-dark mb-1">å¥³ä¸»åå­—</label><input type="text" id="female-name-input" required class="w-full px-4 py-3 border rounded-xl"></div>
                <div><label class="block text-sm font-medium text-text-dark mb-1">ç”·ä¸»åå­—</label><input type="text" id="male-name-input" required class="w-full px-4 py-3 border rounded-xl"></div>
                <button type="submit" class="w-full px-4 py-3 bg-accent text-text-dark font-extrabold rounded-xl shadow-lg hover:bg-accent-dark">ä¿å­˜è®¾ç½®</button>
            </form>
        </div>
    </div>
    
    <!-- Add Event Modal -->
    <div id="add-event-modal" class="fixed inset-0 modal-overlay z-40 flex items-center justify-center p-4 modal-hidden" onclick="if(event.target.id === 'add-event-modal') closeAddEventModal()">
        <div class="bg-card-bg p-6 rounded-2xl shadow-2xl w-full max-w-xl mx-auto transform transition-all">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="event-modal-title" class="text-2xl font-bold text-text-dark">âœï¸ è®°å½•æ–°çš„äº‹ä»¶</h3>
                <button onclick="closeAddEventModal()" class="text-gray-400 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <form id="add-event-form" onsubmit="handleSaveEvent(event)" class="space-y-5">
                <input type="hidden" id="event-id-input" name="eventId">
                <div id="event-edit-display" class="hidden p-4 bg-gray-50 rounded-xl border border-gray-200 text-sm space-y-1">
                    <p class="font-bold">åŸäº‹ç”±: <span id="edit-reason-name-display" class="text-accent-dark"></span></p>
                    <p class="font-bold">åŸå­˜å…¥: <span id="edit-gold-amount-display" class="font-extrabold text-accent text-xl"></span> g <span class="text-gray-500 font-normal ml-2">(ç¼–è¾‘åé‡æ–°è®¡ç®—)</span></p>
                </div>
                <div>
                    <label class="block text-base font-bold text-text-dark mb-2">é€‰æ‹©äº‹ç”±</label>
                    <div class="flex gap-2">
                        <select id="reason-select" name="reasonSelect" required class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white focus:ring-accent focus:border-accent text-text-dark text-lg">
                            <option value="" disabled selected>-- è¯·é€‰æ‹© --</option>
                        </select>
                        <button type="button" onclick="quickAddReason()" class="px-4 bg-gray-100 text-text-dark rounded-xl border border-gray-300 hover:bg-gray-200 font-bold text-xl" title="æ–°å¢äº‹ç”±">+</button>
                    </div>
                </div>
                <div><label class="block text-base font-bold text-text-dark mb-2">æ—¥æœŸ</label><input type="text" id="event-date-input" name="eventDate" required class="w-full px-4 py-3 border border-gray-300 rounded-xl text-lg focus:ring-accent focus:border-accent" placeholder="é€‰æ‹©æ—¥æœŸ..."></div>
                <div><label class="block text-base font-bold text-text-dark mb-2">è¯¦ç»†æè¿°</label><textarea id="description-input" name="description" rows="3" required placeholder="å‘ç”Ÿäº†ä»€ä¹ˆ..." class="w-full px-4 py-3 border rounded-xl text-lg resize-none"></textarea></div>
                <button id="event-submit-btn" type="submit" class="w-full px-4 py-4 bg-accent text-text-dark font-extrabold text-xl rounded-xl shadow-lg hover:bg-accent-dark transition transform hover:scale-[1.01]">æ·»åŠ äº‹ä»¶</button>
            </form>
        </div>
    </div>
    
    <!-- Add Reason Modal -->
    <div id="add-reason-modal" class="fixed inset-0 modal-overlay z-40 flex items-center justify-center p-4 modal-hidden" onclick="if(event.target.id === 'add-reason-modal') closeAddReasonModal()">
        <div class="bg-card-bg p-6 rounded-2xl shadow-2xl w-full max-w-xl mx-auto transform transition-all">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="reason-modal-title" class="text-2xl font-bold text-text-dark">â• æ–°å¢äº‹ç”±</h3>
                <button onclick="closeAddReasonModal()" class="text-gray-400 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <form id="add-reason-form" onsubmit="handleSaveReason(event)" class="space-y-5">
                <input type="hidden" id="reason-id-input" name="reasonId">
                <div><label class="block text-base font-bold text-text-dark mb-2">äº‹ç”±åç§°</label><input type="text" id="new-reason-name" name="reasonName" placeholder="ä¾‹å¦‚: æ‹–å»¶ç—‡" required class="w-full px-4 py-3 border rounded-xl text-lg"></div>
                <div class="relative"><label class="block text-base font-bold text-text-dark mb-2">å•æ¬¡ä¸Šé™ (g)</label><input type="number" id="new-max-gold" name="maxGold" placeholder="æœ€å°1g" value="10" min="1" required class="w-full px-4 py-3 border rounded-xl text-lg pr-10"></div>
                
                <p class="text-sm text-text-secondary italic bg-gray-50 p-3 rounded-lg border border-gray-200">
                    ğŸ’¡ æç¤ºï¼šæœªè¾¾åˆ°å•æ¬¡ä¸Šé™å‰ï¼Œæ¯æ¬¡ç¿»å€
                </p>

                <!-- Changed background to lighter gray (slate-600) -->
                <button type="submit" class="w-full px-4 py-4 bg-slate-600 text-white font-extrabold text-xl rounded-xl shadow-lg hover:bg-slate-700 transition transform hover:scale-[1.01]">ä¿å­˜äº‹ç”±</button>
            </form>
        </div>
    </div>

    <!-- Global Insight Modal -->
    <div id="global-insight-modal" class="fixed inset-0 modal-overlay z-40 flex items-center justify-center p-4 modal-hidden" onclick="if(event.target.id === 'global-insight-modal') closeGlobalInsightModal()">
        <div class="bg-card-bg p-0 rounded-2xl shadow-2xl w-full max-w-2xl mx-auto transform transition-all overflow-hidden flex flex-col max-h-[85vh]">
            <div class="bg-gradient-to-r from-ai-blue to-indigo-600 p-6 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-white flex items-center gap-2">âœ¨ æƒ…æ„Ÿä¸é»„é‡‘æ´å¯ŸæŠ¥å‘Š</h3>
                <button onclick="closeGlobalInsightModal()" class="text-white hover:text-gray-200 text-3xl leading-none">&times;</button>
            </div>
            <div id="global-insight-content" class="p-8 overflow-y-auto custom-scrollbar flex-grow bg-gray-50 min-h-[300px]">
                <!-- AI Content will load here -->
            </div>
            <div class="p-4 bg-white border-t text-center text-gray-500 text-xs">
                ç”± Google Gemini AI æä¾›åˆ†ææ”¯æŒ
            </div>
        </div>
    </div>
    
    <!-- System Modals -->
    <div id="custom-modal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4" onclick="closeModal()">
        <div id="modal-content-wrapper" class="relative bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-95 opacity-0">
            <p id="modal-message" class="text-base font-semibold text-text-dark"></p>
            <button class="absolute top-2 right-2 text-gray-400 text-xl" onclick="closeModal()">Ã—</button>
        </div>
    </div>
    <div id="custom-confirm-modal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <p id="confirm-message" class="text-lg font-semibold text-text-dark mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-btn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">å–æ¶ˆ</button>
                <button id="confirm-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">ç¡®å®š</button>
            </div>
        </div>
    </div>

</body>
</html>